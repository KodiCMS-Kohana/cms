var cms={models:{},views:{},collections:{},routes:{},settings:{},popup_target:null,messages:{init:function(){this.parse(MESSAGE_ERRORS,"error");this.parse(MESSAGE_SUCCESS);$("body").on("show_message",function(){var e=_.toArray(arguments).slice(1);cms.messages.parse(e)})},parse:function(e,t){for(text in e){if(text=="_external"){this.parse(e[text],t);continue}if(t=="error"){cms.error_field(text,e[text])}this.show(e[text],t)}},show:function(e,t){if(!t)t="success";var n=t.charAt(0).toUpperCase()+t.slice(1);window.top.$.pnotify({title:__(n),text:e,sticker:false,nonblock:true,delay:4e3,type:t,history:false})},error:function(e){this.show(e,"error")}},notifications:{_init:false,_list:[],counter:0,container:"#notifications-container",add:function(e,t,n,r,i,s){this._list.push([e,moment(t),n,r,i,s])},update_counter:function(){this.counter++},init:function(){this._build();$(".notifications-list",this.container).slimScroll({height:250});this._init=true},_build_row:function(e){var t=e[0],n=e[1].fromNow(),r=e[2],i=e[3],s=e[4];var o=$('<div class="notification" />');if(!i)var i="";if(r)$('<div class="notification-title '+i+'" />').text(__(r).toUpperCase()).prependTo(o);if(t)$('<div class="notification-description" />').html(t).appendTo(o);if(n)$('<div class="notification-ago margin-xs-vr" />').html(n).appendTo(o);if(s)$('<div class="notification-icon fa fa-'+s+'" />').appendTo(o);return o},_build:function(){var e=$(".notifications-list",this.container);this._list=_.sortBy(this._list,function(e){return!e[1].unix()});for(i in this._list){$notification=this._build_row(this._list[i]);$notification.prependTo(e);if(this._list[i][5]!==false)this.update_counter();delete this._list[i]}$(".counter",this.container).text(parseInt(this.counter))}},error_field:function(e,t){var n=$(".form-group:not(.has-error)");if(typeof e=="object")var r=e;else{e=e.indexOf(".")!==-1?"["+e.replace(/\./g,"][")+"]":e;var r=$(':input[name*="'+e+'"]',n)}r.after('<span class="help-block error-message">'+t+"</span>").closest(".form-group").addClass("has-error");var i=r.closest(".tab-pane").prop("id");if(i){var s=$('.nav-tabs a[href="#'+i+'"]').addClass("tab-error");s.closest(".tabdrop").find(".dropdown-toggle").addClass("tab-error")}},clear_error:function(e,t){var n=$(".form-group");if(typeof e=="object")n=$(".form-group",e);n.removeClass("has-error").find(".error-message").remove();if(t!==false)$(".nav-tabs li a").removeClass("tab-error")},loader:{counter:0,init:function(e){e=$("body");return $('<div class="_loader_container"><span>'+__("Loading")+"</span></div>").appendTo(e).css({width:e.outerWidth(true),height:e.outerHeight(true),top:e.offset().top,left:e.offset().left}).prop("id","loader"+ ++this.counter)},show:function(e,t){if(!t){t=500}var n=this.init(e).fadeTo(t,.4);return this.counter},hide:function(e){if(!e)cont=$("._loader_container");else cont=$("#loader"+e);cont.stop().fadeOut(400,function(){$(this).remove()})}},content_height:null,calculateContentHeight:function(){if(this.content_height!=null)return this.content_height;var e=$("#content-wrapper"),t=$("#main-navbar"),n=$("footer"),r=$(window);var i=r.outerHeight()-t.outerHeight(),s=e.outerHeight(!$("body").hasClass("iframe"))-e.innerHeight()+$("body").hasClass("iframe")?0:140;this.content_height=i-s;return this.content_height},translations:{},plugins:{},filters:{filters:[],switchedOn:{},editors:{},add:function(e,t,n,r){if(t==undefined||n==undefined){cms.messages.error("System try to add filter without required callbacks.",e,t,n);return}this.filters.push([e,t,n,r])},switchOn:function(e,t,n){$("#"+e).css("display","block");if(this.filters.length>0){var r=this.get(e);var i=null;for(var s=0;s<this.filters.length;s++){if(this.filters[s][0]==t){i=this.filters[s];break}}if(r!==i){this.switchOff(e)}try{this.switchedOn[e]=i;this.editors[e]=i[1](e,n);$("#"+e).trigger("filter:switch:on",this.editors[e])}catch(o){}}},switchOff:function(e){var t=this.get(e);try{if(t&&typeof t[2]=="function"){t[2](this.editors[e],e)}this.switchedOn[e]=null;$("#"+e).trigger("filter:switch:off")}catch(n){}},get:function(e){for(var t in this.switchedOn){if(t==e)return this.switchedOn[t]}return null},exec:function(e,t,n){var r=this.get(e);if(r&&typeof r[3]=="function")return r[3](this.editors[e],t,e,n);return false}},filemanager:{open:function(e,t){return $.fancybox.open({href:BASE_URL+"/elfinder/",type:"iframe"},{autoSize:false,width:1e3,afterLoad:function(){this.content[0].contentWindow.elfinderInit(e,t)}})}}};cms.addTranslation=function(e){for(var t in e){cms.translations[t]=e[t]}};cms.ui={callbacks:[],add:function(e,t){if(typeof t!="function")return this;cms.ui.callbacks.push([e,t]);return this},init:function(e){$("body").trigger("before_ui_init");for(var t=0;t<cms.ui.callbacks.length;t++){try{if(!e)cms.ui.callbacks[t][1]();else if(_.isArray(e)&&_.indexOf(e,cms.ui.callbacks[t][0])!=-1){cms.ui.callbacks[t][1]()}else if(e==cms.ui.callbacks[t][0]){cms.ui.callbacks[t][1]()}}catch(n){console.log(cms.ui.callbacks[t][0],n)}}$("body").trigger("after_ui_init")}};cms.init={callbacks:[],add:function(e,t){if(typeof t!="function")return this;if(typeof e=="object"){for(var n=0;n<e.length;n++)cms.init.callbacks.push([e[n],t])}else if(typeof e=="string"){cms.init.callbacks.push([e,t])}cms.init.callbacks.reverse();return this},run:function(){$("body").trigger("before_cms_init");var e=$("body:first").attr("id");for(var t=0;t<cms.init.callbacks.length;t++){var n="body_"+cms.init.callbacks[t][0];if(e==n)cms.init.callbacks[t][1]()}$("body").trigger("after_cms_init")}};cms.ui.add("flags",function(){$("body").on("click",".flags .label",function(e){var t=$(this).parent().data("target");if(!t)t=$(this).parent().prevAll(":input");else t=$(t);var n=$(this).parent();var r=n.data("append")==true;var s=n.data("array")==true;var o=$(this).data("value");if(s)o=o.split(",");if(r){if(t.is(":input")){var u=t.val().split(", ");u.push(o);u=_.uniq(_.compact(u));t.val(u.join(", "))}else{var u=t.text().split(", ");u.push(o);u=_.uniq(_.compact(u));t.text(u.join(", "))}$(".label",n).removeClass("label-success");for(i in u){$('.label[data-value="'+u[i]+'"]').addClass("label-success")}}else{$(".label",n).removeClass("label-success");$(this).addClass("label-success");if(t.hasClass("select2-offscreen")){t.select2("val",o)}else if(t.is(":input")){t.val(o)}else{t.text(o)}}e.preventDefault()})}).add("btn-confirm",function(){$("body").on("click",".btn-confirm",function(e){if(!confirm(__("Are you sure?")))e.preventDefault()})}).add("calculate_height",function(){cms.calculateContentHeight();$(window).resize(function(){cms.content_height=null;cms.calculateContentHeight()})}).add("panel-toggler",function(){var e="fa-chevron-up",t="fa-chevron-down";$(".panel-toggler").click(function(){var n=$(this);if(n.data("target-")){r=$(n.data("target-"))}else{var r=n.next(".panel-spoiler")}r.slideToggle("fast",function(){var r=n.find(".panel-toggler-icon");if($(this).is(":hidden")){r.removeClass(e).addClass(t).addClass("fa")}else{r.addClass(e).removeClass(t).addClass("fa")}});return false}).each(function(){if($(this).data("hash")==window.location.hash.substring(1)){$(this).click();$("html,body").animate({scrollTop:$(this).offset().top},"slow")}}).append('<div class="panel-heading-controls"><span class="text-sm"><i class="panel-toggler-icon fa '+t+'" />&nbsp;&nbsp;&nbsp;'+__("Toggle")+"</span></div>")}).add("datepicker",function(){var e={format:"Y-m-d H:i:00",lang:LOCALE,dayOfWeekStart:1};$(".datetimepicker").each(function(){var t=$.extend({},e);var n=$(this);if(n.data("range-max-input")){t["onShow"]=function(e){var t=$(n.data("range-max-input"));this.setOptions({maxDate:t.val()?t.val():false})}}if(n.data("range-min-input")){t["onShow"]=function(e){var t=$(n.data("range-min-input"));this.setOptions({minDate:t.val()?t.val():false})}}n.datetimepicker(t)});$(".datepicker").each(function(){var t=$.extend(e,{timepicker:false,format:"Y-m-d"});var n=$(this);if(n.data("range-max-input")){t["onShow"]=function(e){var t=$(n.data("range-max-input"));this.setOptions({maxDate:t.val()?t.val():false})}}else if(n.data("range-min-input")){t["onShow"]=function(e){var t=$(n.data("range-min-input"));this.setOptions({minDate:t.val()?t.val():false})}}n.datetimepicker(t)});$(".timepicker").each(function(){var t=$.extend(e,{timepicker:true,datepicker:false,format:"H:i:s"});var n=$(this);n.datetimepicker(t)})}).add("slug",function(){var e={};$("body").on("keyup",".slug-generator",function(){var t=$(".slug");if($(this).data("slug")){t=$($(this).data("slug"))}$separator="-";if($(this).data("separator")){$separator=$(this).data("separator")}if(t.is(":input")&&t.val()=="")e[t]=true;t.on("keyup",function(){e[t]=false});if(e[t]){var n=getSlug($(this).val(),{separator:$separator});if(t.is(":input"))t.val(n);else t.text(n)}});$("body").on("keyup",".slug",function(){var t=String.fromCharCode(event.keyCode);var n=t.match(/\w/);if(!n&&event.keyCode!="32")return;$separator="-";if($(this).data("separator")){$separator=$(this).data("separator")}var r=getSlug($(this).val(),{separator:$separator});$(this).val(r);e[$(this)]=false;if($(this).val()=="")e[$(this)]=true})}).add("dropzone",function(){cms.uploader=new Dropzone(".dropzone",{success:function(e,t){var n=$.parseJSON(t);var r=this;if(n.code!=200){cms.messages.error(n.message)}else if(n.message){cms.messages.show(n.message)}$(e.previewElement).fadeOut(500,function(){r.removeFile(e)})},error:function(e,t){cms.messages.error(t);this.removeFile(e)},dictDefaultMessage:__("Drop files here to upload"),dictFallbackMessage:__("Your browser does not support drag'n'drop file uploads."),dictFallbackText:__("Please use the fallback form below to upload your files like in the olden days."),dictFileTooBig:__("File is too big ({{filesize}}MB). Max filesize: {{maxFilesize}}MB."),dictInvalidFileType:__("You can't upload files of this type."),dictResponseError:__("Server responded with {{statusCode}} code."),dictCancelUpload:__("Cancel upload"),dictCancelUploadConfirmation:__("Are you sure you want to cancel this upload?"),dictRemoveFile:__("Remove file"),dictMaxFilesExceeded:__("You can only upload {{maxFiles}} files.")})}).add("fancybox",function(){$(".fancybox-image").fancybox()}).add("popup",function(){$(".popup").fancybox({fitToView:true,autoSize:false,width:"99%",height:"99%",openEffect:"none",closeEffect:"none",beforeLoad:function(){var e=this.href.split("?")[0];var t=$.query.load(this.href).set("type","iframe").toString();this.href=e+t;var n=this.element.data("title");if(n!==false){this.title=n?n:this.element.html()}cms.popup_target=this.element},helpers:{title:{type:"inside",position:"top"}}});var e=ACTION=="add"?"put":"post";var t=$(".iframe .form-actions");var n=CONTROLLER;if(typeof API_FORM_ACTION!="undefined")n=API_FORM_ACTION;$(".btn-save",t).on("click",function(t){var r=$("form").serializeObject();Api[e](n,r);t.preventDefault()});$(".btn-save-close",t).on("click",function(t){var r=$("form").serializeObject();Api[e](n,r,function(e){window.top.$.fancybox.close()});t.preventDefault()});$(".btn-close",t).on("click",function(e){window.top.$.fancybox.close();e.preventDefault()})}).add("select2",function(){if(!e)var e=",";$("select").not(".no-script").select2();$(".tags").select2({tags:[],minimumInputLength:0,tokenSeparators:[e],createSearchChoice:function(e,t){if($(t).filter(function(){return this.text.localeCompare(e)===0}).length===0){return{id:e,text:e}}},multiple:true,ajax:{url:Api.build_url("tags"),dataType:"json",data:function(e,t){return{term:e}},results:function(e,t){if(!e.response)return{results:[]};return{results:e.response}}},initSelection:function(e,t){var n=[];var r=e.val().split(",");for(i in r){n.push({id:r[i],text:r[i]})}t(n)}})}).add("ajax_form",function(){$("body").on("submit","form.form-ajax",function(){var e=$(this),t=$("button",e).attr("disabled","disabled"),n=e.attr("action");if(e.data("ajax-action"))n=e.data("ajax-action");Api.post(n,e.serialize(),function(e){setTimeout(function(){t.removeAttr("disabled")},5e3)});return false})}).add("filemanager",function(){var e=$(":input[data-filemanager]");e.each(function(){var e=$(this);var t=$('<button class="btn" type="button"><i class="fa fa-folder-open"></i></button>');if(e.next().hasClass("input-group-btn")){t.prependTo(e.next())}else{t.insertAfter(e)}t.on("click",function(){cms.filemanager.open(e)});e.removeAttr("data-filemanager")});$("body").on("click",".btn-filemanager",function(){var e=$(this).data("el");var t=$(this).data("type");if(!e)return false;cms.filemanager.open(e,t);return false})}).add("hotkeys",function(){$("*[data-hotkeys]").each(function(){var e=$(this),t=e.data("hotkeys"),n=function(e){e.preventDefault()};if(e.is(":submit")||e.hasClass("popup")){n=function(t){e.trigger("click");t.preventDefault()}}else if(e.attr("href")){n=function(t){if(e.hasClass("btn-confirm")){if(!confirm(__("Are you sure?")))return false}window.location=e.attr("href");t.preventDefault()}}else if(e.hasClass("panel-toggler")){n=function(t){e.trigger("click");$("body").scrollTo(e);t.preventDefault()}}else if(e.hasClass("nav-tabs")){n=function(t){var n=e.find("li.active"),r=n.next();if(r.hasClass("nav-section")){r=r.next()}if(n.is(":last-child")){r=e.parent().find("li:first-child")}r.find("a").trigger("click");t.preventDefault()}}else if(e.is(":checkbox")){n=function(t){if(e.prop("checked"))e.uncheck().trigger("change");else e.check().trigger("change");t.preventDefault()}}$(document).on("keydown",null,t,n)});$(document).on("keydown",null,"shift+f1",function(e){Api.delete("cache");e.preventDefault()});$(document).on("keydown",null,"shift+f3",function(e){Api.get("search.update_index");e.preventDefault()});$(document).on("keydown",null,"shift+f4",function(e){Api.post("layout.rebuild");e.preventDefault()});$(document).on("keydown",null,"ctrl+shift+l",function(e){window.location="/backend/logout";e.preventDefault()})}).add("api_buttons",function(){$(".btn[data-api-url]").on("click",function(e){e.preventDefault();var t=$(this);var n=function(e){};var r=t.data("api-url");if(!r)return;var n=t.data("callback");if(n)n=window[n];else n=function(e){};var i=t.data("method");var s=t.data("reload");if(s){if(s===true)n=function(){window.location=""};else n=function(){window.location=s}}if(!i)i="GET";Api.request(i,r,null,n)})}).add("select_all_checkbox",function(){$(document).on("change",'input[name="check_all"]',function(e){var t=$(this),n=t.data("target");if(!n)return false;$(n).prop("checked",this.checked).trigger("change");e.preventDefault()})}).add("icon",function(){$("*[data-icon]").add("*[data-icon-prepend]").each(function(){$(this).html('<i class="fa fa-'+$(this).data("icon")+'"></i> '+$(this).html());$(this).removeAttr("data-icon-prepend").removeAttr("data-icon")});$("*[data-icon-append]").each(function(){$(this).html($(this).html()+'&nbsp&nbsp<i class="fa fa-'+$(this).data("icon-append")+'"></i>');$(this).removeAttr("data-icon-append")})}).add("tabbable",function(){$(".tabbable").each(function(e){var t=$(this);if($("> .panel-heading",t).size()>0){var n=$('<div class="tab-content no-padding-t" />').prependTo(t);var r=$('<ul class="nav nav-tabs tabs-generated" style="position:relative; margin-top: 10px;" />').insertBefore(t);$("> .panel-heading",t).each(function(t){var s=$("<li></li>").appendTo(r);var o=$(this).nextUntil(".panel-heading").not(".panel-footer").removeClass("panel-spoiler");$(this).find(".panel-title").removeClass("panel-title");$(this).find(".panel-heading-controls").remove();var u=$('<div class="tab-pane" id="panel-tab-'+e+""+""+t+'" />').append(o).appendTo(n);$('<a href="#panel-tab-'+e+""+""+t+'" data-toggle="tab"></a>').html($(this).html()).appendTo(s);$(this).remove()});$("li a",r).on("click",function(){window.location.hash=$(this).attr("href")})}});if(window.location.hash.length>0&&$(".tabs-generated li a[href="+window.location.hash+"]").length>0){$("li a[href="+window.location.hash+"]").parent().addClass("active");$(".tabbable .tab-pane"+window.location.hash).addClass("active")}else{$(".tabs-generated li:first-child").addClass("active");$(".tabbable .tab-pane:first-child").addClass("active")}$(".tabs-generated").tabdrop()});var Api={_response:null,get:function(e,t,n,r){var i=this.request("GET",e,t,n,r);if(r===false)this._response=i.responseJSON;return this.response()},post:function(e,t,n,r){var i=this.request("POST",e,t,n,r);if(r===false)this._response=i.responseJSON;return this.response()},put:function(e,t,n,r){var i=this.request("PUT",e,t,n,r);if(r===false)this._response=i.responseJSON;return this.response()},"delete":function(e,t,n,r){var i=this.request("DELETE",e,t,n,r);if(r===false)this._response=i.responseJSON;return this.response()},request:function(e,t,n,r,i){url=Api.build_url(t);var s=new Object;$.ajaxSetup({contentType:"application/json"});if(typeof n=="object"&&e!="GET")n=JSON.stringify(n);return $.ajax({type:e,url:url,data:n,dataType:"json",async:i!==false,success:function(t){if(t.code!=200){if(typeof r=="function")r(t);return Api.exception(t)}if(t.message){cms.clear_error();if(t.message instanceof Object){cms.messages.parse(t.message)}else{cms.messages.show(t.message)}}if(t.redirect){$.get(window.top.CURRENT_URL,function(e){window.location=t.redirect+"?type=iframe"})}this._response=t;var n=e+url.replace(SITE_URL,":").replace(/\//g,":");window.top.$("body").trigger(n.toLowerCase(),[this._response.response]);if(typeof r=="function")r(this._response)},error:function(e,t,n){if(typeof r=="function")r(t)}})},build_url:function(e){e=e.replace("/"+ADMIN_DIR_NAME,"");if(e.indexOf("-")==-1){e="-"+e}else if(e.indexOf("-")>0&&(e.indexOf("/")==-1||e.indexOf("/")>0)){e="/"+e}if(e.indexOf("/api")==-1){e="api"+e}if(e.indexOf(ADMIN_DIR_NAME)==-1){if(e.indexOf("/")!=0){e=ADMIN_DIR_NAME+"/"+e}else{e=ADMIN_DIR_NAME+e}}if(e.indexOf(SITE_URL)==-1){e=SITE_URL+e}return e},exception:function(e){if(e.code==120&&typeof e.errors=="object"){cms.clear_error();for(i in e.errors){cms.messages.error(e.errors[i],"error");cms.error_field(i,e.errors[i])}}else if(e.message){cms.clear_error();cms.messages.error(e.message,"error")}},response:function(){return this._response}};$(function(){cms.ui.init();KodiCMS.start(null,cms.settings);cms.init.run();setTimeout(function(){cms.notifications.init()},1500);cms.messages.init()})