var cms={models:{},views:{},collections:{},routes:{},settings:{},popup_target:null,messages:{init:function(){this.parse(MESSAGE_ERRORS,"error"),this.parse(MESSAGE_SUCCESS),$("body").on("show_message",function(){var t=_.toArray(arguments).slice(1);cms.messages.parse(t)})},parse:function(t,e){for(text in t)"_external"!=text?("error"==e&&cms.error_field(text,decodeURIComponent(t[text])),this.show(t[text],e)):this.parse(t[text],e)},show:function(t,e){e||(e="success");var i=e.charAt(0).toUpperCase()+e.slice(1);window.top.$.pnotify({title:__(i),text:decodeURIComponent(t),sticker:!1,nonblock:!0,delay:4e3,type:e,history:!1})},error:function(t){this.show(t,"error")}},notifications:{_init:!1,_list:[],counter:0,container:"#notifications-container",add:function(t,e,i,n,a,s){this._list.push([t,moment(e),i,n,a,s])},update_counter:function(){this.counter++},init:function(){this._build(),$(".notifications-list",this.container).slimScroll({height:250}),this._init=!0},_build_row:function(t){var e=t[0],i=t[1].fromNow(),n=t[2],a=t[3],s=t[4],o=$('<div class="notification" />');if(!a)var a="";return n&&$('<div class="notification-title '+a+'" />').text(__(n).toUpperCase()).prependTo(o),e&&$('<div class="notification-description" />').html(e).appendTo(o),i&&$('<div class="notification-ago margin-xs-vr" />').html(i).appendTo(o),s&&$('<div class="notification-icon fa fa-'+s+'" />').appendTo(o),o},_build:function(){var t=$(".notifications-list",this.container);this._list=_.sortBy(this._list,function(t){return!t[1].unix()});for(i in this._list)$notification=this._build_row(this._list[i]),$notification.prependTo(t),this._list[i][5]!==!1&&this.update_counter(),delete this._list[i];$(".counter",this.container).text(parseInt(this.counter))}},error_field:function(t,e){var i=$(".form-group:not(.has-error)");if("object"==typeof t)var n=t;else{t=-1!==t.indexOf(".")?"["+t.replace(/\./g,"][")+"]":t;var n=$(':input[name*="'+t+'"]',i)}n.after('<span class="help-block error-message">'+e+"</span>").closest(".form-group").addClass("has-error");var a=n.closest(".tab-pane").prop("id");if(a){var s=$('.nav-tabs a[href="#'+a+'"]').addClass("tab-error");s.closest(".tabdrop").find(".dropdown-toggle").addClass("tab-error")}},clear_error:function(t,e){var i=$(".form-group");"object"==typeof t&&(i=$(".form-group",t)),i.removeClass("has-error").find(".error-message").remove(),e!==!1&&$(".nav-tabs li a").removeClass("tab-error")},loader:{counter:0,init:function(t){return t=$("body"),$('<div class="_loader_container"><span>'+__("Loading")+"</span></div>").appendTo(t).css({width:t.outerWidth(!0),height:t.outerHeight(!0),top:t.offset().top,left:t.offset().left}).prop("id","loader"+ ++this.counter)},show:function(t,e){e||(e=500);this.init(t).fadeTo(e,.4);return this.counter},hide:function(t){cont=$(t?"#loader"+t:"._loader_container"),cont.stop().fadeOut(400,function(){$(this).remove()})}},content_height:null,calculateContentHeight:function(){if(null!=this.content_height)return this.content_height;var t=$("#content-wrapper"),e=$("#main-navbar"),i=($("footer"),$(window)),n=i.outerHeight()-e.outerHeight(),a=t.outerHeight(!$("body").hasClass("iframe"))-t.innerHeight()+$("body").hasClass("iframe")?0:140;return this.content_height=n-a,this.content_height},translations:{},plugins:{},filters:{filters:[],switchedOn:{},editors:{},add:function(t,e,i,n){return void 0==e||void 0==i?void cms.messages.error("System try to add filter without required callbacks.",t,e,i):void this.filters.push([t,e,i,n])},switchOn:function(t,e,i){if($("#"+t).css("display","block"),this.filters.length>0){for(var n=this.get(t),a=null,s=0;s<this.filters.length;s++)if(this.filters[s][0]==e){a=this.filters[s];break}n!==a&&this.switchOff(t);try{this.switchedOn[t]=a,this.editors[t]=a[1](t,i),$("#"+t).trigger("filter:switch:on",this.editors[t])}catch(o){}}},switchOff:function(t){var e=this.get(t);try{e&&"function"==typeof e[2]&&e[2](this.editors[t],t),this.switchedOn[t]=null,$("#"+t).trigger("filter:switch:off")}catch(i){}},get:function(t){for(var e in this.switchedOn)if(e==t)return this.switchedOn[e];return null},exec:function(t,e,i){var n=this.get(t);return n&&"function"==typeof n[3]?n[3](this.editors[t],e,t,i):!1}},filemanager:{open:function(t){return $.fancybox.open({href:BASE_URL+"/elfinder/",type:"iframe"},{autoSize:!1,width:1e3,afterLoad:function(){this.content[0].contentWindow.elfinderInit({getFileCallback:function(e){_.isObject(e)&&(e=e.url),_.isObject(t)?(t.val(e),window.top.$.fancybox.close()):window.top.cms.filters.exec(t,"insert",e)&&window.top.$.fancybox.close()}})}})}}};cms.addTranslation=function(t){for(var e in t)cms.translations[e]=t[e]},cms.ui={callbacks:[],add:function(t,e){return"function"!=typeof e?this:(cms.ui.callbacks.push([t,e]),this)},init:function(t){$("body").trigger("before_ui_init");for(var e=0;e<cms.ui.callbacks.length;e++)try{t?_.isArray(t)&&-1!=_.indexOf(t,cms.ui.callbacks[e][0])?cms.ui.callbacks[e][1]():t==cms.ui.callbacks[e][0]&&cms.ui.callbacks[e][1]():cms.ui.callbacks[e][1]()}catch(i){console.log(cms.ui.callbacks[e][0],i)}$("body").trigger("after_ui_init")}},cms.init={callbacks:[],add:function(t,e){if("function"!=typeof e)return this;if("object"==typeof t)for(var i=0;i<t.length;i++)cms.init.callbacks.push([t[i],e]);else"string"==typeof t&&cms.init.callbacks.push([t,e]);return cms.init.callbacks.reverse(),this},run:function(){$("body").trigger("before_cms_init");for(var t=$("body:first").attr("id"),e=0;e<cms.init.callbacks.length;e++){var i="body_"+cms.init.callbacks[e][0];t==i&&cms.init.callbacks[e][1]()}$("body").trigger("after_cms_init")}},cms.ui.add("flags",function(){$("body").on("click",".flags .label",function(t){var e=$(this).parent().data("target");e=e?$(e):$(this).parent().prevAll(":input");var n=$(this).parent(),a=1==n.data("append"),s=1==n.data("array"),o=$(this).data("value");if(s&&(o=o.split(",")),a){if(e.is(":input")){var r=e.val().split(", ");r.push(o),r=_.uniq(_.compact(r)),e.val(r.join(", "))}else{var r=e.text().split(", ");r.push(o),r=_.uniq(_.compact(r)),e.text(r.join(", "))}$(".label",n).removeClass("label-success");for(i in r)$('.label[data-value="'+r[i]+'"]').addClass("label-success")}else $(".label",n).removeClass("label-success"),$(this).addClass("label-success"),e.hasClass("select2-offscreen")?e.select2("val",o):e.is(":input")?e.val(o):e.text(o);t.preventDefault()})}).add("btn-confirm",function(){$("body").on("click",".btn-confirm",function(t){confirm(__("Are you sure?"))||t.preventDefault()})}).add("calculate_height",function(){cms.calculateContentHeight(),$(window).resize(function(){cms.content_height=null,cms.calculateContentHeight()})}).add("panel-toggler",function(){var t="fa-chevron-up",e="fa-chevron-down";$(".panel-toggler").click(function(){var i=$(this);if(i.data("target-"))n=$(i.data("target-"));else var n=i.next(".panel-spoiler");return n.slideToggle("fast",function(){var n=i.find(".panel-toggler-icon");$(this).is(":hidden")?n.removeClass(t).addClass(e).addClass("fa"):n.addClass(t).removeClass(e).addClass("fa")}),!1}).each(function(){$(this).data("hash")==window.location.hash.substring(1)&&($(this).click(),$("html,body").animate({scrollTop:$(this).offset().top},"slow"))}).append('<div class="panel-heading-controls"><span class="text-sm"><i class="panel-toggler-icon fa '+e+'" />&nbsp;&nbsp;&nbsp;'+__("Toggle")+"</span></div>")}).add("datepicker",function(){var t={format:"Y-m-d H:i:00",lang:LOCALE,dayOfWeekStart:1};$(".datetimepicker").each(function(){var e=$.extend({},t),i=$(this);i.data("range-max-input")&&(e.onShow=function(){var t=$(i.data("range-max-input"));this.setOptions({maxDate:t.val()?t.val():!1})}),i.data("range-min-input")&&(e.onShow=function(){var t=$(i.data("range-min-input"));this.setOptions({minDate:t.val()?t.val():!1})}),i.datetimepicker(e)}),$(".datepicker").each(function(){var e=$.extend(t,{timepicker:!1,format:"Y-m-d"}),i=$(this);i.data("range-max-input")?e.onShow=function(){var t=$(i.data("range-max-input"));this.setOptions({maxDate:t.val()?t.val():!1})}:i.data("range-min-input")&&(e.onShow=function(){var t=$(i.data("range-min-input"));this.setOptions({minDate:t.val()?t.val():!1})}),i.datetimepicker(e)}),$(".timepicker").each(function(){var e=$.extend(t,{timepicker:!0,datepicker:!1,format:"H:i:s"}),i=$(this);i.datetimepicker(e)})}).add("slug",function(){var t={};$("body").on("keyup",".slug-generator",function(){var e=$(".slug");if($(this).data("slug")&&(e=$($(this).data("slug"))),$separator="-",$(this).data("separator")&&($separator=$(this).data("separator")),e.is(":input")&&""==e.val()&&(t[e]=!0),e.on("keyup",function(){t[e]=!1}),t[e]){var i=getSlug($(this).val(),{separator:$separator});e.is(":input")?e.val(i):e.text(i)}}),$("body").on("keyup",".slug",function(){var e=String.fromCharCode(event.keyCode),i=e.match(/\w/);if(i||"32"==event.keyCode){$separator="-",$(this).data("separator")&&($separator=$(this).data("separator"));var n=getSlug($(this).val(),{separator:$separator});$(this).val(n),t[$(this)]=!1,""==$(this).val()&&(t[$(this)]=!0)}})}).add("dropzone",function(){Dropzone.autoDiscover=!1,$(".dropzone").length&&(cms.uploader=new Dropzone(".dropzone",{success:function(t,e){var i=$.parseJSON(e),n=this;200!=i.code?cms.messages.error(i.message):i.message&&cms.messages.show(i.message),$(t.previewElement).fadeOut(500,function(){n.removeFile(t)})},error:function(t,e){cms.messages.error(e),this.removeFile(t)},dictDefaultMessage:__("Drop files here to upload"),dictFallbackMessage:__("Your browser does not support drag'n'drop file uploads."),dictFallbackText:__("Please use the fallback form below to upload your files like in the olden days."),dictFileTooBig:__("File is too big ({{filesize}}MB). Max filesize: {{maxFilesize}}MB."),dictInvalidFileType:__("You can't upload files of this type."),dictResponseError:__("Server responded with {{statusCode}} code."),dictCancelUpload:__("Cancel upload"),dictCancelUploadConfirmation:__("Are you sure you want to cancel this upload?"),dictRemoveFile:__("Remove file"),dictMaxFilesExceeded:__("You can only upload {{maxFiles}} files.")}))}).add("fancybox",function(){$(".fancybox-image").fancybox()}).add("popup",function(){$(".popup").fancybox({fitToView:!0,autoSize:!1,width:"99%",height:"99%",openEffect:"none",closeEffect:"none",beforeLoad:function(){var t=this.href.split("?")[0],e=$.query.load(this.href).set("type","iframe").toString();this.href=t+e;var i=this.element.data("title");i!==!1&&(this.title=i?i:this.element.html()),cms.popup_target=this.element},helpers:{title:{type:"inside",position:"top"}}});var t="add"==ACTION?"put":"post",e=$(".iframe .form-actions"),i=CONTROLLER;"undefined"!=typeof API_FORM_ACTION&&(i=API_FORM_ACTION),$(".btn-save",e).on("click",function(e){var n=$("form").serializeObject();Api[t](i,n),e.preventDefault()}),$(".btn-save-close",e).on("click",function(e){var n=$("form").serializeObject();Api[t](i,n,function(){window.top.$.fancybox.close()}),e.preventDefault()}),$(".btn-close",e).on("click",function(t){window.top.$.fancybox.close(),t.preventDefault()}),CLOSE_POPUP&&setTimeout(function(){window.top.$.fancybox.close()},1e3)}).add("select2",function(){if(!t)var t=",";$("select").not(".no-script").select2(),$(".tags").select2({tags:[],minimumInputLength:0,tokenSeparators:[t],createSearchChoice:function(t,e){return 0===$(e).filter(function(){return 0===this.text.localeCompare(t)}).length?{id:t,text:t}:void 0},multiple:!0,ajax:{url:Api.build_url("tags"),dataType:"json",data:function(t){return{term:t}},results:function(t){return t.response?{results:t.response}:{results:[]}}},initSelection:function(t,e){var n=[],a=t.val().split(",");for(i in a)n.push({id:a[i],text:a[i]});e(n)}})}).add("ajax_form",function(){$("body").on("submit","form.form-ajax",function(){var t=$(this),e=$("button",t).attr("disabled","disabled"),i=t.attr("action");return t.data("ajax-action")&&(i=t.data("ajax-action")),Api.post(i,t.serialize(),function(){setTimeout(function(){e.removeAttr("disabled")},5e3)}),!1})}).add("filemanager",function(){var t=$(":input[data-filemanager]");t.each(function(){var t=$(this),e=$('<button class="btn" type="button"><i class="fa fa-folder-open"></i></button>');t.next().hasClass("input-group-btn")?e.prependTo(t.next()):e.insertAfter(t),e.on("click",function(){cms.filemanager.open(t)}),t.removeAttr("data-filemanager")}),$("body").on("click",".btn-filemanager",function(){var t=$(this).data("el"),e=$(this).data("type");return t?(cms.filemanager.open(t,e),!1):!1})}).add("hotkeys",function(){$("*[data-hotkeys]").each(function(){var t=$(this),e=t.data("hotkeys"),i=function(t){t.preventDefault()};t.is(":submit")||t.hasClass("popup")?i=function(e){t.trigger("click"),e.preventDefault()}:t.attr("href")?i=function(e){return t.hasClass("btn-confirm")&&!confirm(__("Are you sure?"))?!1:(window.location=t.attr("href"),void e.preventDefault())}:t.hasClass("panel-toggler")?i=function(e){t.trigger("click"),$("body").scrollTo(t),e.preventDefault()}:t.hasClass("nav-tabs")?i=function(e){var i=t.find("li.active"),n=i.next();n.hasClass("nav-section")&&(n=n.next()),i.is(":last-child")&&(n=t.parent().find("li:first-child")),n.find("a").trigger("click"),e.preventDefault()}:t.is(":checkbox")&&(i=function(e){t.prop("checked")?t.uncheck().trigger("change"):t.check().trigger("change"),e.preventDefault()}),$(document).on("keydown",null,e,i)}),$(document).on("keydown",null,"shift+f1",function(t){Api["delete"]("cache"),t.preventDefault()}),$(document).on("keydown",null,"shift+f3",function(t){Api.get("search.update_index"),t.preventDefault()}),$(document).on("keydown",null,"shift+f4",function(t){Api.post("layout.rebuild"),t.preventDefault()}),$(document).on("keydown",null,"ctrl+shift+l",function(t){window.location="/backend/logout",t.preventDefault()})}).add("api_buttons",function(){$(".btn[data-api-url]").on("click",function(t){t.preventDefault();var e=$(this),i=function(){},n=e.data("api-url");if(n){var i=e.data("callback");i=i?window[i]:function(){};var a=e.data("method"),s=e.data("reload"),o=e.data("params");s&&(i=s===!0?function(){window.location=""}:function(){window.location=s}),a||(a="GET"),Api.request(a,n,o,i)}})}).add("select_all_checkbox",function(){$(document).on("change",'input[name="check_all"]',function(t){var e=$(this),i=e.data("target");return i?($(i).prop("checked",this.checked).trigger("change"),void t.preventDefault()):!1})}).add("icon",function(){$("*[data-icon]").add("*[data-icon-prepend]").each(function(){$(this).html('<i class="fa fa-'+$(this).data("icon")+'"></i> '+$(this).html()),$(this).removeAttr("data-icon-prepend").removeAttr("data-icon")}),$("*[data-icon-append]").each(function(){$(this).html($(this).html()+'&nbsp&nbsp<i class="fa fa-'+$(this).data("icon-append")+'"></i>'),$(this).removeAttr("data-icon-append")})}).add("tabbable",function(){$(".tabbable").each(function(t){var e=$(this);if($("> .panel-heading",e).size()>0){var i=$('<div class="tab-content no-padding-t" />').prependTo(e),n=$('<ul class="nav nav-tabs tabs-generated" style="position:relative; margin-top: 10px;" />').insertBefore(e);$("> .panel-heading",e).each(function(e){var a=$("<li></li>").appendTo(n),s=$(this).nextUntil(".panel-heading").not(".panel-footer").removeClass("panel-spoiler");$(this).find(".panel-title").removeClass("panel-title"),$(this).find(".panel-heading-controls").remove();$('<div class="tab-pane" id="panel-tab-'+t+e+'" />').append(s).appendTo(i);$('<a href="#panel-tab-'+t+e+'" data-toggle="tab"></a>').html($(this).html()).appendTo(a),$(this).remove()}),$("li a",n).on("click",function(){window.location.hash=$(this).attr("href")})}}),window.location.hash.length>0&&$(".tabs-generated li a[href="+window.location.hash+"]").length>0?($("li a[href="+window.location.hash+"]").parent().addClass("active"),$(".tabbable .tab-pane"+window.location.hash).addClass("active")):($(".tabs-generated li:first-child").addClass("active"),$(".tabbable .tab-pane:first-child").addClass("active")),$(".tabs-generated").tabdrop()});var Api={_response:null,get:function(t,e,i,n){var a=this.request("GET",t,e,i,n);return n===!1&&(this._response=a.responseJSON),this.response()},post:function(t,e,i,n){var a=this.request("POST",t,e,i,n);return n===!1&&(this._response=a.responseJSON),this.response()},put:function(t,e,i,n){var a=this.request("PUT",t,e,i,n);return n===!1&&(this._response=a.responseJSON),this.response()},"delete":function(t,e,i,n){var a=this.request("DELETE",t,e,i,n);return n===!1&&(this._response=a.responseJSON),this.response()},request:function(t,e,i,n,a){url=Api.build_url(e);new Object;return $.ajaxSetup({contentType:"application/json"}),"object"==typeof i&&"GET"!=t&&(i=JSON.stringify(i)),$.ajax({type:t,url:url,data:i,dataType:"json",async:a!==!1,success:function(e){if(200!=e.code)return"function"==typeof n&&n(e),Api.exception(e);e.message&&(cms.clear_error(),e.message instanceof Object?cms.messages.parse(e.message):cms.messages.show(e.message)),e.redirect&&$.get(window.top.CURRENT_URL,function(){window.location=e.redirect+"?type=iframe"}),this._response=e;var i=t+url.replace(SITE_URL,":").replace(/\//g,":");window.top.$("body").trigger(i.toLowerCase(),[this._response.response]),"function"==typeof n&&n(this._response)},error:function(t,e){"function"==typeof n&&n(e)}})},build_url:function(t){return-1!==t.indexOf(ADMIN_DIR_NAME)&&(t=t.substring(t.indexOf(ADMIN_DIR_NAME)+ADMIN_DIR_NAME.length)),-1==t.indexOf("-")?t="-"+t:t.indexOf("-")>0&&(-1==t.indexOf("/")||t.indexOf("/")>0)&&(t="/"+t),-1==t.indexOf("/api")&&(t="api"+t),-1==t.indexOf(ADMIN_DIR_NAME)&&(t=0!=t.indexOf("/")?ADMIN_DIR_NAME+"/"+t:ADMIN_DIR_NAME+t),-1==t.indexOf(SITE_URL)&&(t=SITE_URL+t),t},exception:function(t){if(120==t.code&&"object"==typeof t.errors){cms.clear_error();for(i in t.errors)cms.messages.error(t.errors[i],"error"),cms.error_field(i,t.errors[i])}else t.message&&(cms.clear_error(),cms.messages.error(t.message,"error"))},response:function(){return this._response}};$(function(){cms.ui.init(),KodiCMS.start(null,cms.settings),cms.init.run(),setTimeout(function(){cms.notifications.init()},1500),cms.messages.init()}),function(t){var e={settings:{updateOnResize:!1,contentHeight:!1,type:"height",offset:0,minHeight:0,onCalculate:function(t,e){t.css(this.type,e)},onResize:function(t,i){t.css(e.settings.type,i)}},children:function(i,n,a){return i.children().each(function(){var i=t(this);n.is(i)||i.is(":hidden")||(i.find(n).size()>0?(a-=i.outerHeight(!0)-i.outerHeight(),a=e.children(i,n,a)):a-=i.outerHeight(!0))}),a},get_calculated_height:function(t,i){var n=this.get_content_height(t);return n=this.children(t,i,n),n-=parseInt(e.settings.offset),n<e.settings.minHeight&&(n=e.settings.minHeight),n},get_content_height:function(t){var e=0;return e=this.settings.contentHeight?"boolean"==typeof this.settings.contentHeight||"auto"==this.settings.contentHeight?cms.calculateContentHeight():parseInt(this.settings.contentHeight):t.height(),e-3},get_taget_object:function(e,i){return"string"==typeof e||e instanceof String?t(e,i):$target_object instanceof jQuery?e:!1}};t.fn.calcHeightFor=function(i,n){e.settings=t.extend(e.settings,n);var a=t(this);if($target_object=e.get_taget_object(i,this),$target_object&&0!=a.find($target_object).size()){var s=e.get_content_height(a);return s=e.children(t(this),$target_object,s)}},t.fn.setHeightFor=function(i,n){return e.settings=t.extend(e.settings,n),this.each(function(){var n=t(this);if($target_object=e.get_taget_object(i,this),$target_object&&0!=n.find($target_object).size()){var a=$target_object.size();$target_object.each(function(){var i=t(this),s=e.get_calculated_height(n,i)/a;e.settings.onCalculate(i,s),e.settings.updateOnResize&&t(window).on("resize",n,function(){var t=e.get_calculated_height(n,i)/a;e.settings.onResize(i,t)})})}})}}(jQuery);